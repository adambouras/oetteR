---
title: "Visualising Regression Models"
author: "Bjoern Oettinghaus"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE
  , eval = T
  , comment = "#>"
  , out.width = '30%'
  , message = F
  , warning = F
  , echo = T
)
```

```{r}
suppressPackageStartupMessages( require(oetteR) )
suppressPackageStartupMessages( require(tidyverse) )
```

# Introduction

Alluvial Plots can be a powerfull tool to visualise categorical data. It will group observations that have similar values across a set of dimensions and visualise them as flows. The individual flows can be emphasised through different colouring methods.

# Alluvial Plots

## Visualize Data in a tidy data format

For this dataformat the `f_plot_alluvial` function is suitable. Also see the help documentation and the examples of that function.

### Data

```{r}

data_ls = mtcars %>%
  f_clean_data()

data = data_ls$data
max_variables = 5
variables = c( data_ls$categoricals[1:3], data_ls$numericals[1:3] )


knitr::kable(data)

```

### Colouring

```{r}

f_plot_alluvial( data = data
                , variables = variables
                , max_variables = max_variables
                , fill_by = 'first_variable' )

f_plot_alluvial( data = data
                , variables = variables
                , max_variables = max_variables
                , fill_by = 'last_variable' )

f_plot_alluvial( data = data
                , variables = variables
                , max_variables = max_variables
                , fill_by = 'all_flows' )

f_plot_alluvial( data = data
                , variables = variables
                , max_variables = max_variables
                , fill_by = 'values' )

```

### Ordering

The order of the variables on the x axis is determined by the parameter variables. The order of the y values can be changed using the oder_levels argument.

```{r}

f_plot_alluvial( data = data
                , variables = variables
                , max_variables = max_variables
                , fill_by = 'values'
                , order_levels = c('1', '0') )


```

## Visualize data in the 'gathered' format

### Data

Here we have more than one row for each observation and measurements that belong to the same group such as mean arrival delay is gathered in one column, which is indexed by the quarter column. In an alluvial Plot we might want to add another 

```{r}

monthly_flights = nycflights13::flights %>%
  group_by(month, tailnum, origin, dest, carrier) %>%
  summarise() %>%
  group_by( tailnum, origin, dest, carrier) %>%
  count() %>%
  filter( n == 12 ) %>%
  select( - n ) %>%
  left_join( nycflights13::flights ) %>%
  .[complete.cases(.), ] %>%
  ungroup() %>%
  mutate( tailnum = pmap_chr(list(tailnum, origin, dest, carrier), paste )
          , qu = cut(month, 4)) %>%
  group_by(tailnum, carrier, origin, dest, qu ) %>%
  summarise( mean_arr_delay = mean(arr_delay) ) %>%
  ungroup() %>%
  mutate( mean_arr_delay = ifelse( mean_arr_delay < 10, 'on_time', 'late' ) )

levels(monthly_flights$qu) = c('Q1', 'Q2', 'Q3', 'Q4')

data = monthly_flights

knitr::kable(data)

```


### Coloring

```{r}

p = f_plot_alluvial_1v1( data, col_x, col_y, col_id, col_fill )
p = f_plot_alluvial_1v1( data, col_x, col_y, col_id, fill_by = 'last_variable' )
p = f_plot_alluvial_1v1( data, col_x, col_y, col_id, fill_by = 'first_variable' )
p = f_plot_alluvial_1v1( data, col_x, col_y, col_id, fill_by = 'all_flows' )
p = f_plot_alluvial_1v1( data, col_x, col_y, col_id, fill_by = 'value' )

```

